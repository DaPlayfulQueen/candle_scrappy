options:
  logging: CLOUD_LOGGING_ONLY
steps:
  # metabase
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud container clusters get-credentials candle-cluster --zone europe-west1 --project strange-mind-410708
        kubectl apply -f metabase.yaml
        kubectl rollout status deployment metabase-deployment

  # mongo
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        kubectl apply -f mongo-pvc.yaml
        kubectl create secret generic mongo-secrets \
          --from-literal=mongo-user=$(gcloud secrets versions access latest --secret=mongo-user) \
          --from-literal=mongo-password=$(gcloud secrets versions access latest --secret=mongo-password) || true

  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        kubectl apply -f mongo.yaml
        kubectl rollout status deployment mongo-deployment

  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'build'
    - '-t'
    - 'europe-west1-docker.pkg.dev/strange-mind-410708/candle-scrappy/ingestor:latest'
    - '--build-arg'
    - 'CRON_SCHEDULE=*/10 * * * *'  # Adjust the cron schedule as needed
    - '-f'
    - './ingestor/Dockerfile'
    - './ingestor'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west1-docker.pkg.dev/strange-mind-410708/candle-scrappy/ingestor:latest']

  # ingestor
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        kubectl apply -f ingestor-config.yaml

  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        kubectl apply -f ingestor.yaml
        kubectl rollout status deployment ingestor-deployment